name: Ads List

on:
  workflow_dispatch:
  # 每天 22:00 触发一次
  schedule:
    - cron: '0 6 * * *'
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Add token
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          token: ${{ secrets.PAT_TOKEN }}
        
      - name: Download and merge list files
        run: |
          # 定义要下载的 URL 列表
          urls=(
            "https://raw.githubusercontent.com/qianyounai/Geo-Rules/main/category-ads-all.list"
            "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/adobe-ads%40ads.list"
            "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/alibaba-ads%40ads.list"
            "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/baidu-ads%40ads.list"
            "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/google-ads%40ads.list"
            "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/netease-ads%40ads.list"
            "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/tencent-ads%40ads.list"
            "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/yahoo-ads%40ads.list"
          )
          
          # 清空或创建输出文件
          > Ads.list
          
          # 标记是否是第一个文件
          first_file=true
          
          # 遍历每个 URL
          for url in "${urls[@]}"; do
            # 提取文件名（去掉 .list 后缀）
            filename=$(basename "$url" | sed 's/%40/@/g' | sed 's/.list$//')
            
            echo "正在下载: $filename"
            
            # 下载文件到临时文件
            if curl -sSL "$url" -o temp.list; then
              # 如果不是第一个文件，添加空行
              if [ "$first_file" = false ]; then
                echo "
                " >> Ads.list
              fi
              
              # 添加文件名注释
              echo "# $filename" >> Ads.list
              
              # 添加 URL
              echo "# $url" >> Ads.list
              
              # 追加文件内容
              cat temp.list >> Ads.list
              
              echo "✓ 已合并: $filename"
              first_file=false
            else
              echo "✗ 下载失败: $filename"
            fi
          done
          
          # 清理临时文件
          rm -f temp.list
          
          echo "合并完成！"
          
      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 如果 Ads.list 是新文件或有变化，则添加并提交
          if [ ! -f Ads.list ] || ! git diff --quiet Ads.list || git ls-files --others --exclude-standard | grep -q "Ads.list"; then
            git add Ads.list
            git commit -m "Update Ads.list - $(date +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "已提交更新"
          else
            echo "没有检测到变化"
          fi
